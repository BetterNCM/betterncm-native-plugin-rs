(()=>{var M;(u=>{function o(m,y=100){return n(()=>document.querySelector(m),y)}u.waitForElement=o;function a(m,y){let w=0;return function(){let i=this,d=arguments;w&&clearTimeout(w),w=setTimeout(m.bind(i,d),y)}}u.debounce=a;function n(m,y=100){return new Promise(w=>{let t=setInterval(()=>{let i=m();i&&(clearInterval(t),w(i))},y)})}u.waitForFunction=n;function c(m){return new Promise(y=>setTimeout(y,m))}u.delay=c;function l(m,y,...w){let t=document.createElement(m);if(y.class){for(let i of y.class)t.classList.add(i);y.class=void 0}if(y.style){for(let i in y.style)t.style[i]=y.style[i];y.style=void 0}for(let i in y)y[i]&&(t[i]=y[i]);for(let i of w)i&&t.appendChild(i);return t}u.dom=l})(M||={});function Q(){return"React"in window&&"createElement"in React&&"Fragment"in React?(window.h=React.createElement,window.f=React.Fragment,!0):"h"in window&&"f"in window}M.waitForFunction(Q,100);var ee=window.fetch,P=(o,a)=>(a?(a.headers=a.headers??{},a.ignoreApiKey||(a.headers.BETTERNCM_API_KEY=BETTERNCM_API_KEY)):a={headers:{BETTERNCM_API_KEY}},ee(BETTERNCM_API_PATH+o,a));var K=encodeURIComponent,T;(d=>{function o(g){return new Promise((r,e)=>{betterncm_native.fs.readDir(g,r,e)})}d.readDir=o;async function a(g){try{return await(await n(g)).text()}catch{return""}}d.readFileText=a;async function n(g){try{return P(`/api/fs/read_file?path=${K(g)}`).then(r=>r.blob())}catch{return new Blob}}d.readFile=n;async function c(g){throw new TypeError("\u672A\u5B9E\u73B0")}d.mountDir=c;async function l(g){throw new TypeError("\u672A\u5B9E\u73B0")}d.mountFile=l;async function u(g,r=`${g}_extracted/`){throw new TypeError("\u672A\u5B9E\u73B0")}d.unzip=u;function m(g,r){return y(g,r)}d.writeFileText=m;async function y(g,r){return(await P(`/api/fs/write_file?path=${K(g)}`,{method:"POST",body:r})).ok}d.writeFile=y;async function w(g){return new Promise((r,e)=>{betterncm_native.fs.mkdir(g,r,e)})}d.mkdir=w;function t(g){return betterncm_native.fs.exists(g)}d.exists=t;async function i(g){return new Promise((r,e)=>{betterncm_native.fs.remove(g,r,e)})}d.remove=i})(T||={});var W=encodeURIComponent,j;(C=>{async function o(s,x=!1,b=!1){return betterncm_native.app.exec(s,x,b)}C.exec=o;let a=null;function n(){return betterncm_native.app.version()}C.getBetterNCMVersion=n;async function c(){return await(await P("/app/bg_screenshot")).blob()}C.takeBackgroundScreenshot=c;async function l(){return await(await P("/app/get_win_position",{ignoreApiKey:!0})).json()}C.getNCMWinPos=l;async function u(){return new Promise((s,x)=>{betterncm_native.app.reloadPlugins(s,x)})}C.reloadPlugins=u;async function m(){return betterncm_native.app.getDataPath().replace(/\//g,"\\")}C.getDataPath=m;async function y(s,x){return new Promise((b,_)=>{betterncm_native.app.readConfig(s,x,b,_)})}C.readConfig=y;async function w(s,x){return new Promise((b,_)=>{betterncm_native.app.writeConfig(s,x,b,_)})}C.writeConfig=w;function t(){return betterncm_native.app.getNCMPath()}C.getNCMPath=t;function i(s=!0){betterncm_native.app.showConsole(s)}C.showConsole=i;async function d(s=!0){betterncm_native.app.setRoundedCorner(s)}C.setRoundedCorner=d;async function g(s,x){return await(await P(`/app/open_file_dialog?filter=${W(s)}&initialDir=${W(x)}`)).text()}C.openFileDialog=g;async function r(){return await(await P("/app/is_light_theme")).json()}C.isLightTheme=r;async function e(){return await(await P("/app/get_succeeded_hijacks")).json()}C.getSucceededHijacks=e})(j||={});var I;(g=>{function o(r,e){for(let C in r){let s=!0;for(let x=0,b=e;x<b.length;x++){let _=b[x];r[C].toString().includes(_)||(s=!1)}if(s)return C}}g.findNativeFunction=o;function a(r){channel.call("os.navigateExternal",()=>{},[r])}g.openUrl=a;function n(){return window?.APP_CONF?.packageVersion||"0000000"}g.getNCMPackageVersion=n;function c(){return window?.APP_CONF?.appver||"0.0.0.0"}g.getNCMFullVersion=c;function l(){let r=c();return r.substring(0,r.lastIndexOf("."))}g.getNCMVersion=l;function u(){let r=c();return parseInt(r.substring(r.lastIndexOf(".")+1))}g.getNCMBuild=u;function m(r,e=window,C=["window"],s=[],x=[]){if(e==null)return[];if(s.push(e),typeof r=="string")typeof e[r]=="function"&&x.push([e[r],e,[...C]]);else for(let b of Object.keys(e))Object.hasOwnProperty.call(e,b)&&typeof e[b]=="function"&&r(e[b])&&x.push([e[b],e,[...C]]);if(C.length<10)for(let b of Object.keys(e))Object.hasOwnProperty.call(e,b)&&typeof e[b]=="object"&&!s.includes(e[b])&&!(C.length===1&&s[s.length-1]===window&&b==="betterncm")&&(C.push(b),m(r,e[b],C,s,x),C.pop());return s.pop(),x}g.searchApiFunction=m;function y(r,e=window,C=["window"],s=[],x=[]){if(e==null)return[];if(s.push(e),C.length<10)for(let b of Object.keys(e))Object.hasOwnProperty.call(e,b)&&!s.includes(e[b])&&!(C.length===1&&s[s.length-1]===window&&b==="betterncm")&&(typeof e[b]=="object"?(C.push(b),m(r,e[b],C,s,x),C.pop()):r(e[b])&&x.push([e[b],e,[...C]]));return s.pop(),x}g.searchForData=y;function w(r,e=window,C=["window"],s=[]){if(e==null)return null;if(s.push(e),typeof r=="string"){if(typeof e[r]=="function")return[e[r],e,[...C]]}else for(let x of Object.keys(e))if(Object.hasOwnProperty.call(e,x)&&typeof e[x]=="function"&&r(e[x]))return[e[x],e,[...C]];if(C.length<10){for(let x of Object.keys(e))if(Object.hasOwnProperty.call(e,x)&&typeof e[x]=="object"&&!s.includes(e[x])&&!(C.length===1&&s[s.length-1]===window&&x==="betterncm")){C.push(x);let b=w(r,e[x],C,s);if(C.pop(),b)return b}}return s.pop(),null}g.findApiFunction=w;let t=null;function i(){if(t===null){let r=w("getPlaying");if(r){let[e,C]=r;t=e.bind(C)}}return t===null?null:t()}g.getPlayingSong=i;function d(){let r=i(),e={id:r.data.id,title:r.data.name,type:"normal"};return r.from.fm&&(e.type="fm"),e}g.getPlaying=d})(I||={});var V;(n=>{async function o(c){console.warn("Test Failed",c),await T.writeFileText("/__TEST_FAILED__.txt",c)}n.fail=o;async function a(c){console.warn("Test Succeeded",c),await T.writeFileText("/__TEST_SUCCEEDED__.txt",c)}n.success=a})(V||={});var S=o=>{let{children:a,className:n,...c}=o;return h("a",{className:`u-ibtn5 u-ibtnsz8 ${n||""}`,...c},a)};var q=o=>h("span",{className:"bncm-spinner",style:{width:o.size||"16px",height:o.size||"16px"}},h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null));var z=o=>{let[a,n]=React.useState("transparent"),c=React.useMemo(()=>k(),[]),[l,u]=React.useState(null),[m,y]=React.useState(""),w=React.useMemo(()=>Object.values(E).findIndex(g=>g.manifest.require_restart||g.manifest.native_plugin)!==-1,[]);React.useEffect(()=>{(async()=>{if(!l){let g=await p.app.getBetterNCMVersion();y(g);let r=p.ncm.getNCMVersion(),C=(await(await fetch("https://gitee.com/microblock/better-ncm-v2-data/raw/master/betterncm/betterncm.json")).json()).versions.filter(s=>s.supports.includes(r));if(C.length===0)n("#F004"),u({version:"",supports:[],file:"",changelog:""});else{let s=C[0];s.version!==g&&n("#0F04"),u(s)}}})()},[l]);let t=React.useCallback(async()=>{if(l&&l.version!==m){let g=await p.app.getNCMPath(),e=`${await p.app.getDataPath()}\\betterncm.dll`;await p.fs.exists("./betterncm.dll")&&await p.fs.remove("./betterncm.dll"),await p.fs.writeFile("./betterncm.dll",await(await fetch(l?.file)).blob()),g.toLowerCase().includes("system")||p.app.exec(["cmd /c @echo off","echo BetterNCM Updating...","cd /d C:/","cd C:/",`cd /d ${g[0]}:/`,`cd "${g}"`,"taskkill /f /im cloudmusic.exe>nul","taskkill /f /im cloudmusicn.exe>nul","ping 127.0.0.1>nul & del msimg32.dll",`move "${e}" .\\msimg32.dll`,"start cloudmusic.exe"].join(" & "),!0)}else l&&u(null)},[l]),[i,d]=React.useState(!1);return h("section",{className:"bncm-mgr-header"},h("img",{src:"https://s1.ax1x.com/2022/08/11/vGlJN8.png",alt:"",style:{height:"64px"}}),h("div",null,h("h1",null,"BetterNCM"," ",h("span",{style:{fontSize:"smaller",opacity:"0.8"}},betterncm_native.app.version())),h("div",{className:"bncm-mgr-btns"},h(S,{onClick:async()=>{p.app.exec(`explorer "${(await p.app.getDataPath()).replace(/\//g,"\\")}"`,!1,!0)}},"\u6253\u5F00\u63D2\u4EF6\u6587\u4EF6\u5939"),h(S,{onClick:()=>{p.app.showConsole(!i),d(!i)}},i?"\u9690\u85CF":"\u6253\u5F00","\u63A7\u5236\u53F0"),w?h(f,null,h(S,{onClick:async()=>{await N(),p.reload()}},"\u91CD\u542F\u7F51\u6613\u4E91")):h(S,{onClick:async()=>{await N(),await p.app.reloadPlugins(),p.reload()}},"\u91CD\u8F7D\u63D2\u4EF6"),h(S,{style:{display:"flex",alignItems:"center",background:a},onClick:t},l===null?h(f,null,h(q,null),"\u68C0\u67E5\u66F4\u65B0\u4E2D"):l.version===m?h(f,null,"\u5DF2\u662F\u6700\u65B0\u7248\u672C"):l.version.length===0?h(f,null,"\u7248\u672C\u4E0D\u517C\u5BB9"):h(f,null,"\u70B9\u51FB\u66F4\u65B0\u5230 ",l.version)))),h("div",{className:"m-tool"},h("a",{className:"itm",onClick:()=>o.onRequestOpenStartupWarnings(),style:{width:"32px",height:"32px"}},h("svg",{width:"32px",height:"32px",viewBox:"0 0 24 24"},h("path",{fill:"currentColor",d:"M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}))),h("a",{className:"itm",onClick:()=>p.ncm.openUrl("https://github.com/MicroCBer/BetterNCM"),style:{width:"32px",height:"32px"}},h("svg",{width:"32px",height:"32px",viewBox:"0 0 24 24"},h("path",{fill:"currentColor",d:"M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"})))))};var U=()=>{let[o,a]=React.useState("");return React.useEffect(()=>{G().then(a)},[]),h("div",{className:"v-scroll"},h("div",null,h("div",{style:{overflowY:"scroll",overflowX:"hidden"},className:"safe-mode-info"},h("h1",null,"\u73B0\u5728\u5904\u4E8E\u5B89\u5168\u6A21\u5F0F"),h("p",null,"BetterNCM \u63D2\u4EF6\u52A0\u8F7D\u5668\u53EF\u80FD\u906D\u9047\u4E86\u591A\u6B21\u63D2\u4EF6\u52A0\u8F7D\u5931\u8D25\u91CD\u8F7D\uFF0C\u5B89\u5168\u6A21\u5F0F\u5DF2\u81EA\u52A8\u542F\u7528\uFF0C\u5728\u8BE5\u6A21\u5F0F\u4E0B\u4E0D\u4F1A\u52A0\u8F7D\u4EFB\u4F55\u63D2\u4EF6\u3002"),h("p",null,"\u63D2\u4EF6\u52A0\u8F7D\u5668\u5DF2\u7ECF\u6536\u96C6\u4E86\u6BCF\u6B21\u52A0\u8F7D\u53D1\u751F\u7684\u9519\u8BEF\uFF0C\u8BF7\u786E\u8BA4\u52A0\u8F7D\u5931\u8D25\u7684\u63D2\u4EF6\uFF0C\u5E76\u5C06\u53D1\u751F\u9519\u8BEF\u7684\u63D2\u4EF6\u624B\u52A8\u79FB\u9664\u6216\u4FEE\u6B63\u3002"),h("p",null,"\u5B8C\u6210\u8C03\u6574\u540E\uFF0C\u53EF\u4EE5\u901A\u8FC7\u6309\u4E0B\u91CD\u8F7D\u63D2\u4EF6\u5173\u95ED\u5B89\u5168\u6A21\u5F0F\u5E76\u91CD\u65B0\u52A0\u8F7D\u63D2\u4EF6\u3002"),h(S,{onClick:async()=>{await N(),betterncm_native.app.restart()}},"\u91CD\u542F\u5E76\u91CD\u8F7D\u63D2\u4EF6"),o.length===0?h("p",null,"\u6CA1\u6709\u627E\u5230\u52A0\u8F7D\u9519\u8BEF\u8BB0\u5F55\uFF0C\u6709\u53EF\u80FD\u662F\u53D7\u5230\u63D2\u4EF6\u5F71\u54CD\u6216\u63D2\u4EF6\u7BA1\u7406\u5668\u81EA\u8EAB\u51FA\u9519\u3002"):h(f,null,h("p",null,"\u52A0\u8F7D\u9519\u8BEF\u8BB0\u5F55\uFF1A"),h("code",null,h("pre",{style:{whiteSpace:"pre-wrap"}},o))))))};var Y=o=>h("div",{className:"startup-warning"},h("h1",null,"\u6B22\u8FCE\u4F7F\u7528 BetterNCM\uFF01"),h("p",null,"BetterNCM \u662F\u4E00\u4E2A\u7531\u4E00\u7FA4\u70ED\u7231\u7F51\u6613\u4E91\u97F3\u4E50\u7684\u4E91\u6751\u6751\u53CB\u5F00\u53D1\u7684 PC \u7248\u7F51\u6613\u4E91\u97F3\u4E50\u6269\u5C55\u5DE5\u5177\uFF0C\u53EF\u4EE5\u63D0\u4F9B\u975E\u5E38\u4E30\u5BCC\u7684\u81EA\u5B9A\u4E49\u529F\u80FD\u6269\u5C55\u589E\u5F3A\u80FD\u529B\u3002"),h("p",null,"\u8003\u8651\u5230\u5DE5\u5177\u6027\u8D28\uFF0CBetterNCM \u5C06",h("b",null,"\u6C38\u8FDC\u662F\u5B8C\u5168\u5F00\u6E90\u514D\u8D39\u7684\u81EA\u7531\u8F6F\u4EF6"),"\uFF0C\u6240\u4EE5\u5982\u679C\u4F60\u662F\u4ECE\u4EFB\u4F55\u5730\u65B9\u53D1\u73B0\u6709\u4EFB\u4F55\u4EBA\u5728\u552E\u5356\u672C\u5DE5\u5177\uFF0C\u8BF7\u7ACB\u523B\u8981\u6C42\u9000\u6B3E\u5E76\u4E3E\u62A5\u5546\u5BB6\uFF01 \u4F5C\u4E3A\u4E00\u7FA4\u7231\u597D\u8005\uFF0C\u6211\u4EEC\u4E0D\u4F1A\u4E5F\u6CA1\u529E\u6CD5\u4E3A\u4F60\u56E0\u4E3A\u4ECE\u5176\u5B83\u9014\u5F84\u8D2D\u4E70\u672C\u5DE5\u5177\u9020\u6210\u7684\u635F\u5931\u8D1F\u8D23\uFF01"),h("p",null,"\u5982\u679C\u4F60\u4E5F\u5E0C\u671B\u4E3A BetterNCM \u8D21\u732E\u4EE3\u7801\uFF0C\u6B22\u8FCE\u524D\u6765 BetterNCM \u7684 Github \u5F00\u6E90\u4ED3\u5E93\uFF1A",h("a",{className:"itm",onClick:()=>p.ncm.openUrl("https://github.com/MicroCBer/BetterNCM"),style:{width:"32px",height:"32px"}},"https://github.com/MicroCBer/BetterNCM")),h("p",null,"\u901A\u8FC7\u70B9\u51FB\u53F3\u4E0A\u89D2\u7684\u7F51\u6613\u4E91\u56FE\u6807\uFF08\u5728\u8BBE\u7F6E\u56FE\u6807\u7684\u53F3\u4FA7\uFF09\u53EF\u4EE5\u6253\u5F00\u63D2\u4EF6\u7BA1\u7406\u5668\uFF0C \u7136\u540E\u901A\u8FC7\u63D2\u4EF6\u7BA1\u7406\u5668\u914D\u5957\u7684\u63D2\u4EF6\u5546\u5E97\uFF0C\u5C31\u53EF\u4EE5\u5B89\u88C5\u4F60\u559C\u6B22\u7684\u63D2\u4EF6\u6765\u6269\u5C55\u7F51\u6613\u4E91\u7684\u529F\u80FD\u548C\u5916\u89C2\u54E6\uFF01"),h("button",{onClick:()=>o.onRequestClose()},"\u5F00\u59CB\u4F7F\u7528 BetterNCM"));var $="config.betterncm.manager.openedwarnings";async function J(){v.setSplashScreenText("\u6B63\u5728\u521D\u59CB\u5316\u63D2\u4EF6\u7BA1\u7406\u5668");let o=document.createElement("section"),a=await p.utils.waitForElement("section.g-mn"),n=await p.utils.waitForElement('a[href="#/m/setting/"]'),c=n.cloneNode(!0);c.href="javascript:void(0)",c.title="BetterNCM",localStorage.getItem($)!=="true"&&c.classList.add("bncm-btn-twinkling"),c.innerHTML=`<svg style='transform: scale(0.8);'><use xlink:href="orpheus://orpheus/style/res/svg/topbar.sp.svg#logo_white"></use></svg>`,a.parentElement.insertBefore(o,a.nextElementSibling),n.parentElement.insertBefore(c,n.nextElementSibling),ReactDOM.render(h(te,null),o),o.classList.add("better-ncm-manager"),o.classList.add("g-mn");function l(){o.parentElement!==a.parentElement&&a.parentElement.insertBefore(o,a.nextElementSibling),o.classList.add("ncmm-show"),a.setAttribute("style","display: none !important;")}function u(){o.classList.remove("ncmm-show"),a.removeAttribute("style")}(async()=>(await p.utils.waitForElement("div.cover.u-cover.u-cover-sm > a > span",1e3)).addEventListener("click",u))(),n.addEventListener("click",u),c.addEventListener("click",()=>{o.classList.contains("ncmm-show")?u():l()}),window.addEventListener("hashchange",u),new MutationObserver(m=>{for(let y of m)y.attributeName==="style"&&(o.style.left=a.style.left)}).observe(a,{attributes:!0})}var O=o=>{},te=()=>{let[o,a]=React.useState(E.PluginMarket),n=React.useRef(null),[c,l]=React.useState([]),[u,m]=React.useState(localStorage.getItem($)!=="true"),[y,w]=React.useState(!1);return React.useEffect(()=>{k().then(w)},[]),React.useEffect(()=>{function t(i,d){let g=r=>{let e=E[r],C=e.haveConfigElement()?1:0;return e.manifest.name.startsWith("PluginMarket")?Number.MAX_SAFE_INTEGER:C};return g(d)-g(i)}l(Object.keys(E).sort(t)),O=i=>{console.log("\u63D2\u4EF6\u52A0\u8F7D\u5B8C\u6210\uFF01"),l(Object.keys(i).sort(t))}},[]),React.useEffect(()=>{let t=o?.injects.map(i=>i._getConfigElement()).filter(i=>i!==null)||[];if(t.length===0){let i=document.createElement("div");i.innerText="\u8BE5\u63D2\u4EF6\u6CA1\u6709\u53EF\u7528\u7684\u8BBE\u7F6E\u9009\u9879",t.push(i)}n.current?.replaceChildren(...t)},[o]),h("div",{className:"bncm-mgr"},h("div",null,h(z,{onRequestOpenStartupWarnings:()=>{m(!u)}}),y?h(U,null):u?h(Y,{onRequestClose:()=>{localStorage.setItem($,"true"),m(!1),document.querySelector(".bncm-btn-twinkling")?.classList.remove("bncm-btn-twinkling")}}):h("section",{style:{display:"flex",flexDirection:"row",flex:"1",marginBottom:"0"}},h("div",{className:"v-scroll loaded-plugins-list",style:{borderRight:"1px solid #8885"}},h("div",null,h("div",null,c.map(t=>{let i=E[t],d=i.haveConfigElement();return h("div",{className:d?o?.manifest.slug===t?"plugin-btn selected":"plugin-btn":"plugin-btn-disabled plugin-btn","data-plugin-slug":t,onClick:()=>{d&&a(i)}},h("span",{className:"plugin-list-name"},i.manifest.name),!i.pluginPath.includes("./plugins_dev")&&i.manifest.name!=="PluginMarket"&&h("span",{className:"plugin-uninstall-btn",onClick:async g=>{g.stopPropagation();let r=i.manifest.require_restart||i.manifest.native_plugin,e=await p.fs.readFileText(`${i.pluginPath}/.plugin.path.meta`);e.length>1&&(await p.fs.remove(e),r&&await p.app.reloadPlugins(),p.reload())}},h("svg",{xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",className:"feather feather-trash-2"},h("polyline",{points:"3 6 5 6 21 6"}),h("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),h("line",{x1:10,y1:11,x2:10,y2:17}),h("line",{x1:14,y1:11,x2:14,y2:17}))))})))),h("div",{className:"v-scroll"},h("div",null,h("div",{style:{overflowY:"scroll",overflowX:"hidden",padding:"16px"},ref:n}))))))};var B=class extends EventTarget{pluginPath="";injects=[];manifest;finished=!1;#e=null;devMode=!1;constructor(a,n,c){super(),this.devMode=c,this.manifest=a,this.pluginPath=n,this.addEventListener("load",l=>{this.injects.forEach(u=>{u.dispatchEvent(l)})}),this.addEventListener("allpluginsloaded",l=>{this.injects.forEach(u=>{u.dispatchEvent(l)})})}haveConfigElement(){return this.#e==null&&(this.#e=this.injects.reduce((a,n)=>a??n._getConfigElement(),null)!==null),this.#e}},X;(c=>{function o(l,u,m=!1,y={}){return dom("a",{class:["u-ibtn5",m&&"u-ibtnsz8"],style:{margin:".2em .5em"},innerText:l,onclick:u,...y})}c.makeBtn=o;function a(l={}){return dom("input",{type:"checkbox",...l})}c.makeCheckbox=a;function n(l,u={}){return dom("input",{value:l,style:{margin:".2em .5em",borderRadius:".5em"},class:["u-txt","sc-flag"],...u})}c.makeInput=n})(X||={});var F=class extends EventTarget{constructor(n,c){super();this.filePath=c;this.mainPlugin=n,this.manifest=n.manifest,this.pluginPath=n.pluginPath}pluginPath="";manifest;configViewElement=null;mainPlugin;loadError=null;finished=!1;onLoad(n){this.addEventListener("load",c=>{try{n.call(this,c.detail,c)}catch(l){this.loadError=l}})}onConfig(n){this.addEventListener("config",c=>{try{this.configViewElement=n.call(this,c.detail)}catch(l){console.warn("\u63D2\u4EF6",this.manifest.name," \u7684\u914D\u7F6E\u7EC4\u4EF6\u52A0\u8F7D\u5931\u8D25",l);let u=document.createElement("div");u.innerText=`\u63D2\u4EF6\u914D\u7F6E\u9875\u9762\u52A0\u8F7D\u51FA\u9519\uFF1A
${l}`,this.configViewElement=u}})}onAllPluginsLoaded(n){this.addEventListener("allpluginsloaded",function(c){n.call(this,c.detail,c)})}getConfig(n,c){try{let l=JSON.parse(localStorage.getItem(`config.betterncm.${this.manifest.slug}`)||"{}");if(l[n]!==void 0)return l[n]}catch{}return c}setConfig(n,c){let l=JSON.parse(localStorage.getItem(`config.betterncm.${this.manifest.slug}`)||"{}");(!l||typeof l!="object")&&(l=Object.create(null)),l[n]=c,localStorage[`config.betterncm.${this.manifest.slug}`]=JSON.stringify(l)}_getConfigElement(){return this.configViewElement||this.dispatchEvent(new CustomEvent("config",{detail:X})),this.configViewElement}};var E={},R="betterncm.safemode",L="betterncm.loaderror",D="cc.microblock.betterncm.cpp_side_inject_feature_disabled",ne=channel.call;channel.call=function(o,a,n,...c){return o==="winhelper.showWindow"&&(console.log(o,...n),P(`/api/internal/set_main_window_hidden?hidden=${n[0]==="hide"}`)),ne(o,a,n,...c)};var v;(l=>{function o(){let u=document.getElementById("bncm-splash-screen");u&&u.animate([{opacity:1},{opacity:0,display:"none"}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42,0,0.58,1)"}).commitStyles()}l.hideSplashScreen=o;function a(){return new Promise(u=>{let m=document.getElementById("bncm-splash-screen");if(!m)return u();let y=m.animate([{opacity:0},{opacity:1}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42, 0, 0.58, 1)"});y.addEventListener("finish",w=>{u()},{once:!0}),y.commitStyles()})}l.showSplashScreen=a;function n(u){let m=document.getElementById("bncm-splash-screen-text");m&&(m.innerText=u)}l.setSplashScreenText=n;function c(u){let m=document.getElementById("bncm-splash-screen-progress");m&&(u===0?m.style.display="none":m.style.display="",m.style.width=`${Math.max(0,Math.min(100,u*100))}%`)}l.setSplashScreenProgress=c})(v||={});async function N(){await p.app.writeConfig(D,"false"),await p.app.writeConfig(R,"false"),await p.app.writeConfig(L,"")}async function ie(){await p.app.writeConfig(D,"true"),await p.app.writeConfig(R,"true")}var A=class extends Error{constructor(n,c,l,u){super(l,u);this.pluginPath=n;this.rawError=c}toString(){return`\u63D2\u4EF6 ${this.pluginPath} \u52A0\u8F7D\u51FA\u9519: ${this.rawError}`}},H=class extends Error{constructor(a,n){super(a,n)}toString(){return`\u63D2\u4EF6\u4F9D\u8D56\u89E3\u6790\u51FA\u9519: ${this}`}},k=()=>p.app.readConfig(R,"false").then(o=>o==="true"),G=()=>p.app.readConfig(L,"").then(o=>o||"");function re(o){class a{adjacencyList={};constructor(){}addVertex(t){this.adjacencyList[t]||(this.adjacencyList[t]=[])}addEdge(t,i){this.adjacencyList[t].push(i)}}let n=new a;for(let w of o)n.addVertex(w.manifest.slug);for(let w of o)w.manifest.loadBefore&&w.manifest.loadBefore.forEach(t=>n.addEdge(t,w.manifest.slug)),w.manifest.loadAfter&&w.manifest.loadAfter.forEach(t=>n.addEdge(w.manifest.slug,t));function c(w,t,i,d){if(i[w]=!0,!(w in n.adjacencyList))throw new H(`\u627E\u4E0D\u5230\u63D2\u4EF6 ${w}`);let g=n.adjacencyList[w];for(let r of g)i[r]||(t=c(r,t,i,d));return d[w]=t,t-1}let l=Object.keys(n.adjacencyList),u={},m={},y=l.length-1;for(let w of l)u[w]||(y=c(w,y,u,m));return Object.keys(m).map(w=>o.find(t=>t.manifest.slug===w))}async function oe(){if(await k()){window.loadedPlugins=E;return}let o=p.utils.debounce(p.reload,1e3),n={"/pub/app.html":"Main"}[location.pathname];async function c(t){let i=t.devMode,d=t.manifest,g=t.pluginPath;i&&!d.noDevReload&&betterncm_native.fs.watchDirectory(g,(e,C)=>{[".js","manifest.json"].findIndex(x=>C.endsWith(x))!==-1&&(console.warn("\u5F00\u53D1\u63D2\u4EF6",d.name,"\u6587\u4EF6",C,"\u53D1\u751F\u66F4\u65B0\uFF0C\u5373\u5C06\u91CD\u8F7D\uFF01"),o())});async function r(e){if(!d.slug)return;let C=await p.fs.readFileText(e);if(e.endsWith(".js")){let s=new F(t,e),x=new Function("plugin",`return (async function ${e.replaceAll(/[/\\\.]/g,"_").replaceAll("-","_").replaceAll(/[^a-zA-Z0-9_$]/g,"")}(){${C}})();`);if(Object.defineProperty(x,"name",{value:e,configurable:!0}),await x.call(E[d.slug],s),s.dispatchEvent(new CustomEvent("load",{detail:s})),s.loadError)throw new A(e,s.loadError,`\u63D2\u4EF6\u811A\u672C ${e} \u52A0\u8F7D\u51FA\u9519: ${s.loadError.stack||s.loadError}`,{cause:s.loadError});s.finished=!0,E[d.slug].injects.push(s)}}if(d.injects[n])for(let e of d.injects[n])await r(`${g}/${e.file}`);if(d.injects[location.pathname])for(let e of d.injects[location.pathname])await r(`${g}/${e.file}`);t.finished=!0}window.loadedPlugins=E,v.setSplashScreenText("\u6B63\u5728\u68C0\u7D22\u63D2\u4EF6"),v.setSplashScreenProgress(0);let l=await p.fs.readDir("./plugins_runtime"),u=[],m=async(t,i)=>{try{let d=JSON.parse(await p.fs.readFileText(`${t}/manifest.json`));d.slug=d.slug??d.name.replace(/[^a-zA-Z0-9 ]/g,"").replace(/ /g,"-");let g=new B(d,t,i);u.push(g)}catch(d){if(d instanceof SyntaxError)console.error("Failed to load plugin:",d);else throw d}};v.setSplashScreenText("\u6B63\u5728\u786E\u8BA4\u63D2\u4EF6\u52A0\u8F7D\u987A\u5E8F"),v.setSplashScreenProgress(0),u=re(u);let y=[];for(let t of l)y.push(m(t,!1));if(v.setSplashScreenText("\u6B63\u5728\u68C0\u7D22\u5F00\u53D1\u63D2\u4EF6"),v.setSplashScreenProgress(0),betterncm_native.fs.exists("./plugins_dev")){let t=await p.fs.readDir("./plugins_dev");for(let i of t)v.setSplashScreenText(`\u6B63\u5728\u52A0\u8F7D\u5F00\u53D1\u63D2\u4EF6 ${i}`),await m(i,!0)}await Promise.all(y);let w=0;for(let t of u)if(t.manifest.slug in E)console.warn("\u63D2\u4EF6",t.manifest.slug,"\u51FA\u73B0\u91CD\u590D\uFF0C\u4F4D\u4E8E",t.pluginPath,"\u7684\u63D2\u4EF6\u5C06\u4E0D\u4F1A\u88AB\u52A0\u8F7D");else{E[t.manifest.slug]=t,console.log("\u6B63\u5728\u52A0\u8F7D\u63D2\u4EF6",t.manifest.slug),v.setSplashScreenText(`\u6B63\u5728\u52A0\u8F7D\u63D2\u4EF6 ${t.manifest.name} (${w++}/${u.length})`),v.setSplashScreenProgress(w/u.length);let i=Date.now();await c(t);let d=Date.now()-i;console.log("\u63D2\u4EF6\u52A0\u8F7D\u5B8C\u6210",t.manifest.slug,"\u7528\u65F6",`${d}ms`)}v.setSplashScreenProgress(1),v.setSplashScreenText("\u6B63\u5728\u5B8C\u6210\u52A0\u8F7D");for(let t in E)E[t].injects.forEach(d=>{if(d.dispatchEvent(new CustomEvent("allpluginsloaded",{detail:E})),d.loadError)throw new A(d.filePath,d.loadError,`\u63D2\u4EF6\u811A\u672C ${d.filePath} \u52A0\u8F7D\u51FA\u9519: ${d.loadError.stack||d.loadError}`,{cause:d.loadError})})}async function se(o){let a="cc.microblock.loader.reloadPluginAttempts",n=parseInt(await p.app.readConfig(a,"0")),c=await p.app.readConfig(L,"");await p.app.writeConfig(L,`${c}\u7B2C ${n+1} \u6B21\u52A0\u8F7D\u53D1\u751F\u9519\u8BEF\uFF1A
${o.stack||o}

`),n<2?await p.app.writeConfig(a,String(n+1)):(await ie(),await p.app.writeConfig(a,"0")),location.reload()}window.addEventListener("DOMContentLoaded",async()=>{let o=betterncm_native.internal.getFrameworkCSS(),a=document.createElement("style");a.innerHTML=o,document.head.appendChild(a),await p.app.readConfig(D,"false")==="false"?localStorage.setItem(R,"false"):localStorage.setItem(R,"true");try{await Promise.race([Promise.all([oe(),J()])])}catch(n){se(n);return}v.setSplashScreenText("\u52A0\u8F7D\u5B8C\u6210\uFF01"),v.hideSplashScreen(),O(E)});function ae(){v.setSplashScreenProgress(0),v.setSplashScreenText("\u6B63\u5728\u91CD\u8F7D"),v.showSplashScreen().then(()=>{betterncm_native.app.restart()})}var Z={fs:T,app:j,ncm:I,utils:M,tests:V,reload:ae,betterncmFetch:P,isMRBNCM:!0};window.dom=M.dom;betterncm=Z;var p=Z;})();
//# sourceMappingURL=framework.js.map
