(()=>{var M;(u=>{function o(g,b=100){return s(()=>document.querySelector(g),b)}u.waitForElement=o;function a(g,b){let y=0;return function(){let i=this,m=arguments;y&&clearTimeout(y),y=setTimeout(g.bind(i,m),b)}}u.debounce=a;function s(g,b=100){return new Promise(y=>{let t=setInterval(()=>{let i=g();i&&(clearInterval(t),y(i))},b)})}u.waitForFunction=s;function c(g){return new Promise(b=>setTimeout(b,g))}u.delay=c;function l(g,b,...y){let t=document.createElement(g);if(b.class){for(let i of b.class)t.classList.add(i);b.class=void 0}if(b.style){for(let i in b.style)t.style[i]=b.style[i];b.style=void 0}for(let i in b)b[i]&&(t[i]=b[i]);for(let i of y)i&&t.appendChild(i);return t}u.dom=l})(M||={});function Z(){return"React"in window&&"createElement"in React&&"Fragment"in React?(window.h=React.createElement,window.f=React.Fragment,!0):"h"in window&&"f"in window}M.waitForFunction(Z,100);var T;(m=>{function o(d){return new Promise((n,e)=>{betterncm_native.fs.readDir(d,n,e)})}m.readDir=o;function a(d){return new Promise((n,e)=>{betterncm_native.fs.readFileText(d,n,e)})}m.readFileText=a;async function s(d){return new Promise((n,e)=>{betterncm_native.fs.readFile(d,n,e)}).then(n=>{let e=new Uint8Array(n);return new Blob([e])})}m.readFile=s;async function c(d){throw new TypeError("\u672A\u5B9E\u73B0")}m.mountDir=c;async function l(d){throw new TypeError("\u672A\u5B9E\u73B0")}m.mountFile=l;async function u(d,n=`${d}_extracted/`){throw new TypeError("\u672A\u5B9E\u73B0")}m.unzip=u;function g(d,n){return new Promise((e,w)=>{betterncm_native.fs.writeFileText(d,n,e,w)})}m.writeFileText=g;async function b(d,n){if(typeof n=="string")return g(d,n);{let e=[...new Uint8Array(await n.arrayBuffer())];return new Promise((w,r)=>{betterncm_native.fs.writeFile(d,e,w,r)})}}m.writeFile=b;async function y(d){return new Promise((n,e)=>{betterncm_native.fs.mkdir(d,n,e)})}m.mkdir=y;function t(d){return betterncm_native.fs.exists(d)}m.exists=t;async function i(d){return new Promise((n,e)=>{betterncm_native.fs.remove(d,n,e)})}m.remove=i})(T||={});var P=(o,a)=>(a?(a.headers=a.headers??{},a.ignoreApiKey||(a.headers.BETTERNCM_API_KEY=BETTERNCM_API_KEY)):a={headers:{BETTERNCM_API_KEY}},fetch(BETTERNCM_API_PATH+o,a));var K=encodeURIComponent,j;(w=>{async function o(r,x=!1,C=!1){return betterncm_native.app.exec(r,x,C)}w.exec=o;let a=null;function s(){return betterncm_native.app.version()}w.getBetterNCMVersion=s;async function c(){return await(await P("/app/bg_screenshot")).blob()}w.takeBackgroundScreenshot=c;async function l(){return await(await P("/app/get_win_position",{ignoreApiKey:!0})).json()}w.getNCMWinPos=l;async function u(){return new Promise((r,x)=>{betterncm_native.app.reloadPlugins(r,x)})}w.reloadPlugins=u;async function g(){return(await(await P("/app/datapath")).text()).replace(/\//g,"\\")}w.getDataPath=g;async function b(r,x){return new Promise((C,_)=>{betterncm_native.app.readConfig(r,x,C,_)})}w.readConfig=b;async function y(r,x){return new Promise((C,_)=>{betterncm_native.app.writeConfig(r,x,C,_)})}w.writeConfig=y;function t(){return betterncm_native.app.getNCMPath()}w.getNCMPath=t;function i(r=!0){betterncm_native.app.showConsole(r)}w.showConsole=i;async function m(r=!0){}w.setRoundedCorner=m;async function d(r,x){return await(await P(`/app/open_file_dialog?filter=${K(r)}&initialDir=${K(x)}`)).text()}w.openFileDialog=d;async function n(){return await(await P("/app/is_light_theme")).json()}w.isLightTheme=n;async function e(){return await(await P("/app/get_succeeded_hijacks")).json()}w.getSucceededHijacks=e})(j||={});var I;(d=>{function o(n,e){for(let w in n){let r=!0;for(let x=0,C=e;x<C.length;x++){let _=C[x];n[w].toString().includes(_)||(r=!1)}if(r)return w}}d.findNativeFunction=o;function a(n){channel.call("os.navigateExternal",()=>{},[n])}d.openUrl=a;function s(){return window?.APP_CONF?.packageVersion||"0000000"}d.getNCMPackageVersion=s;function c(){return window?.APP_CONF?.appver||"0.0.0.0"}d.getNCMFullVersion=c;function l(){let n=c();return n.substring(0,n.lastIndexOf("."))}d.getNCMVersion=l;function u(){let n=c();return parseInt(n.substring(n.lastIndexOf(".")+1))}d.getNCMBuild=u;function g(n,e=window,w=["window"],r=[],x=[]){if(e==null)return[];if(r.push(e),typeof n=="string")typeof e[n]=="function"&&x.push([e[n],e,[...w]]);else for(let C of Object.keys(e))Object.hasOwnProperty.call(e,C)&&typeof e[C]=="function"&&n(e[C])&&x.push([e[C],e,[...w]]);if(w.length<10)for(let C of Object.keys(e))Object.hasOwnProperty.call(e,C)&&typeof e[C]=="object"&&!r.includes(e[C])&&!(w.length===1&&r[r.length-1]===window&&C==="betterncm")&&(w.push(C),g(n,e[C],w,r,x),w.pop());return r.pop(),x}d.searchApiFunction=g;function b(n,e=window,w=["window"],r=[],x=[]){if(e==null)return[];if(r.push(e),w.length<10)for(let C of Object.keys(e))Object.hasOwnProperty.call(e,C)&&!r.includes(e[C])&&!(w.length===1&&r[r.length-1]===window&&C==="betterncm")&&(typeof e[C]=="object"?(w.push(C),g(n,e[C],w,r,x),w.pop()):n(e[C])&&x.push([e[C],e,[...w]]));return r.pop(),x}d.searchForData=b;function y(n,e=window,w=["window"],r=[]){if(e==null)return null;if(r.push(e),typeof n=="string"){if(typeof e[n]=="function")return[e[n],e,[...w]]}else for(let x of Object.keys(e))if(Object.hasOwnProperty.call(e,x)&&typeof e[x]=="function"&&n(e[x]))return[e[x],e,[...w]];if(w.length<10){for(let x of Object.keys(e))if(Object.hasOwnProperty.call(e,x)&&typeof e[x]=="object"&&!r.includes(e[x])&&!(w.length===1&&r[r.length-1]===window&&x==="betterncm")){w.push(x);let C=y(n,e[x],w,r);if(w.pop(),C)return C}}return r.pop(),null}d.findApiFunction=y;let t=null;function i(){if(t===null){let n=y("getPlaying");if(n){let[e,w]=n;t=e.bind(w)}}return t===null?null:t()}d.getPlayingSong=i;function m(){let n=i(),e={id:n.data.id,title:n.data.name,type:"normal"};return n.from.fm&&(e.type="fm"),e}d.getPlaying=m})(I||={});var V;(s=>{async function o(c){console.warn("Test Failed",c),await T.writeFileText("/__TEST_FAILED__.txt",c)}s.fail=o;async function a(c){console.warn("Test Succeeded",c),await T.writeFileText("/__TEST_SUCCEEDED__.txt",c)}s.success=a})(V||={});var S=o=>{let{children:a,className:s,...c}=o;return h("a",{className:`u-ibtn5 u-ibtnsz8 ${s||""}`,...c},a)};var q=o=>h("span",{className:"bncm-spinner",style:{width:o.size||"16px",height:o.size||"16px"}},h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null));var W=o=>{let[a,s]=React.useState("transparent"),c=React.useMemo(()=>k(),[]),[l,u]=React.useState(null),[g,b]=React.useState(""),y=React.useMemo(()=>Object.values(E).findIndex(d=>d.manifest.require_restart||d.manifest.native_plugin)!==-1,[]);React.useEffect(()=>{(async()=>{if(!l){let d=await p.app.getBetterNCMVersion();b(d);let n=p.ncm.getNCMVersion(),w=(await(await fetch("https://gitee.com/microblock/better-ncm-v2-data/raw/master/betterncm/betterncm.json")).json()).versions.filter(r=>r.supports.includes(n));if(w.length===0)s("#F004"),u({version:"",supports:[],file:"",changelog:""});else{let r=w[0];r.version!==d&&s("#0F04"),u(r)}}})()},[l]);let t=React.useCallback(async()=>{if(l&&l.version!==g){let d=await p.app.getNCMPath(),e=`${await p.app.getDataPath()}\\betterncm.dll`;await p.fs.exists("./betterncm.dll")&&await p.fs.remove("./betterncm.dll"),await p.fs.writeFile("./betterncm.dll",await(await fetch(l?.file)).blob()),d.toLowerCase().includes("system")||p.app.exec(["cmd /c @echo off","echo BetterNCM Updating...","cd /d C:/","cd C:/",`cd /d ${d[0]}:/`,`cd "${d}"`,"taskkill /f /im cloudmusic.exe>nul","taskkill /f /im cloudmusicn.exe>nul","ping 127.0.0.1>nul & del msimg32.dll",`move "${e}" .\\msimg32.dll`,"start cloudmusic.exe"].join(" & "),!0)}else l&&u(null)},[l]),[i,m]=React.useState(!1);return h("section",{className:"bncm-mgr-header"},h("img",{src:"https://s1.ax1x.com/2022/08/11/vGlJN8.png",alt:"",style:{height:"64px"}}),h("div",null,h("h1",null,"BetterNCM"," ",h("span",{style:{fontSize:"smaller",opacity:"0.8"}},betterncm_native.app.version())),h("div",{className:"bncm-mgr-btns"},h(S,{onClick:async()=>{p.app.exec(`explorer "${(await p.app.getDataPath()).replace(/\//g,"\\")}"`,!1,!0)}},"\u6253\u5F00\u63D2\u4EF6\u6587\u4EF6\u5939"),h(S,{onClick:()=>{p.app.showConsole(!i),m(!i)}},i?"\u9690\u85CF":"\u6253\u5F00","\u63A7\u5236\u53F0"),y?h(f,null,h(S,{onClick:async()=>{await N(),p.reload()}},"\u91CD\u542F\u7F51\u6613\u4E91")):h(S,{onClick:async()=>{await N(),await p.app.reloadPlugins(),p.reload()}},"\u91CD\u8F7D\u63D2\u4EF6"),h(S,{style:{display:"flex",alignItems:"center",background:a},onClick:t},l===null?h(f,null,h(q,null),"\u68C0\u67E5\u66F4\u65B0\u4E2D"):l.version===g?h(f,null,"\u5DF2\u662F\u6700\u65B0\u7248\u672C"):l.version.length===0?h(f,null,"\u7248\u672C\u4E0D\u517C\u5BB9"):h(f,null,"\u70B9\u51FB\u66F4\u65B0\u5230 ",l.version)))),h("div",{className:"m-tool"},h("a",{className:"itm",onClick:()=>o.onRequestOpenStartupWarnings(),style:{width:"32px",height:"32px"}},h("svg",{width:"32px",height:"32px",viewBox:"0 0 24 24"},h("path",{fill:"currentColor",d:"M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}))),h("a",{className:"itm",onClick:()=>p.ncm.openUrl("https://github.com/MicroCBer/BetterNCM"),style:{width:"32px",height:"32px"}},h("svg",{width:"32px",height:"32px",viewBox:"0 0 24 24"},h("path",{fill:"currentColor",d:"M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"})))))};var z=()=>{let[o,a]=React.useState("");return React.useEffect(()=>{U().then(a)},[]),h("div",{className:"v-scroll"},h("div",null,h("div",{style:{overflowY:"scroll",overflowX:"hidden"},className:"safe-mode-info"},h("h1",null,"\u73B0\u5728\u5904\u4E8E\u5B89\u5168\u6A21\u5F0F"),h("p",null,"BetterNCM \u63D2\u4EF6\u52A0\u8F7D\u5668\u53EF\u80FD\u906D\u9047\u4E86\u591A\u6B21\u63D2\u4EF6\u52A0\u8F7D\u5931\u8D25\u91CD\u8F7D\uFF0C\u5B89\u5168\u6A21\u5F0F\u5DF2\u81EA\u52A8\u542F\u7528\uFF0C\u5728\u8BE5\u6A21\u5F0F\u4E0B\u4E0D\u4F1A\u52A0\u8F7D\u4EFB\u4F55\u63D2\u4EF6\u3002"),h("p",null,"\u63D2\u4EF6\u52A0\u8F7D\u5668\u5DF2\u7ECF\u6536\u96C6\u4E86\u6BCF\u6B21\u52A0\u8F7D\u53D1\u751F\u7684\u9519\u8BEF\uFF0C\u8BF7\u786E\u8BA4\u52A0\u8F7D\u5931\u8D25\u7684\u63D2\u4EF6\uFF0C\u5E76\u5C06\u53D1\u751F\u9519\u8BEF\u7684\u63D2\u4EF6\u624B\u52A8\u79FB\u9664\u6216\u4FEE\u6B63\u3002"),h("p",null,"\u5B8C\u6210\u8C03\u6574\u540E\uFF0C\u53EF\u4EE5\u901A\u8FC7\u6309\u4E0B\u91CD\u8F7D\u63D2\u4EF6\u5173\u95ED\u5B89\u5168\u6A21\u5F0F\u5E76\u91CD\u65B0\u52A0\u8F7D\u63D2\u4EF6\u3002"),h(S,{onClick:async()=>{await N(),betterncm_native.app.restart()}},"\u91CD\u542F\u5E76\u91CD\u8F7D\u63D2\u4EF6"),o.length===0?h("p",null,"\u6CA1\u6709\u627E\u5230\u52A0\u8F7D\u9519\u8BEF\u8BB0\u5F55\uFF0C\u6709\u53EF\u80FD\u662F\u53D7\u5230\u63D2\u4EF6\u5F71\u54CD\u6216\u63D2\u4EF6\u7BA1\u7406\u5668\u81EA\u8EAB\u51FA\u9519\u3002"):h(f,null,h("p",null,"\u52A0\u8F7D\u9519\u8BEF\u8BB0\u5F55\uFF1A"),h("code",null,h("pre",{style:{whiteSpace:"pre-wrap"}},o))))))};var G=o=>h("div",{className:"startup-warning"},h("h1",null,"\u6B22\u8FCE\u4F7F\u7528 BetterNCM\uFF01"),h("p",null,"BetterNCM \u662F\u4E00\u4E2A\u7531\u4E00\u7FA4\u70ED\u7231\u7F51\u6613\u4E91\u97F3\u4E50\u7684\u4E91\u6751\u6751\u53CB\u5F00\u53D1\u7684 PC \u7248\u7F51\u6613\u4E91\u97F3\u4E50\u6269\u5C55\u5DE5\u5177\uFF0C\u53EF\u4EE5\u63D0\u4F9B\u975E\u5E38\u4E30\u5BCC\u7684\u81EA\u5B9A\u4E49\u529F\u80FD\u6269\u5C55\u589E\u5F3A\u80FD\u529B\u3002"),h("p",null,"\u8003\u8651\u5230\u5DE5\u5177\u6027\u8D28\uFF0CBetterNCM \u5C06",h("b",null,"\u6C38\u8FDC\u662F\u5B8C\u5168\u5F00\u6E90\u514D\u8D39\u7684\u81EA\u7531\u8F6F\u4EF6"),"\uFF0C\u6240\u4EE5\u5982\u679C\u4F60\u662F\u4ECE\u4EFB\u4F55\u5730\u65B9\u53D1\u73B0\u6709\u4EFB\u4F55\u4EBA\u5728\u552E\u5356\u672C\u5DE5\u5177\uFF0C\u8BF7\u7ACB\u523B\u8981\u6C42\u9000\u6B3E\u5E76\u4E3E\u62A5\u5546\u5BB6\uFF01 \u4F5C\u4E3A\u4E00\u7FA4\u7231\u597D\u8005\uFF0C\u6211\u4EEC\u4E0D\u4F1A\u4E5F\u6CA1\u529E\u6CD5\u4E3A\u4F60\u56E0\u4E3A\u4ECE\u5176\u5B83\u9014\u5F84\u8D2D\u4E70\u672C\u5DE5\u5177\u9020\u6210\u7684\u635F\u5931\u8D1F\u8D23\uFF01"),h("p",null,"\u5982\u679C\u4F60\u4E5F\u5E0C\u671B\u4E3A BetterNCM \u8D21\u732E\u4EE3\u7801\uFF0C\u6B22\u8FCE\u524D\u6765 BetterNCM \u7684 Github \u5F00\u6E90\u4ED3\u5E93\uFF1A",h("a",{className:"itm",onClick:()=>p.ncm.openUrl("https://github.com/MicroCBer/BetterNCM"),style:{width:"32px",height:"32px"}},"https://github.com/MicroCBer/BetterNCM")),h("p",null,"\u901A\u8FC7\u70B9\u51FB\u53F3\u4E0A\u89D2\u7684\u7F51\u6613\u4E91\u56FE\u6807\uFF08\u5728\u8BBE\u7F6E\u56FE\u6807\u7684\u53F3\u4FA7\uFF09\u53EF\u4EE5\u6253\u5F00\u63D2\u4EF6\u7BA1\u7406\u5668\uFF0C \u7136\u540E\u901A\u8FC7\u63D2\u4EF6\u7BA1\u7406\u5668\u914D\u5957\u7684\u63D2\u4EF6\u5546\u5E97\uFF0C\u5C31\u53EF\u4EE5\u5B89\u88C5\u4F60\u559C\u6B22\u7684\u63D2\u4EF6\u6765\u6269\u5C55\u7F51\u6613\u4E91\u7684\u529F\u80FD\u548C\u5916\u89C2\u54E6\uFF01"),h("button",{onClick:()=>o.onRequestClose()},"\u5F00\u59CB\u4F7F\u7528 BetterNCM"));var $="config.betterncm.manager.openedwarnings";async function Y(){v.setSplashScreenText("\u6B63\u5728\u521D\u59CB\u5316\u63D2\u4EF6\u7BA1\u7406\u5668");let o=document.createElement("section"),a=await p.utils.waitForElement("section.g-mn"),s=await p.utils.waitForElement('a[href="#/m/setting/"]'),c=s.cloneNode(!0);c.href="javascript:void(0)",c.title="BetterNCM",localStorage.getItem($)!=="true"&&c.classList.add("bncm-btn-twinkling"),c.innerHTML=`<svg style='transform: scale(0.8);'><use xlink:href="orpheus://orpheus/style/res/svg/topbar.sp.svg#logo_white"></use></svg>`,a.parentElement.insertBefore(o,a.nextElementSibling),s.parentElement.insertBefore(c,s.nextElementSibling),ReactDOM.render(h(Q,null),o),o.classList.add("better-ncm-manager"),o.classList.add("g-mn");function l(){o.parentElement!==a.parentElement&&a.parentElement.insertBefore(o,a.nextElementSibling),o.classList.add("ncmm-show"),a.setAttribute("style","display: none !important;")}function u(){o.classList.remove("ncmm-show"),a.removeAttribute("style")}(async()=>(await p.utils.waitForElement("div.cover.u-cover.u-cover-sm > a > span",1e3)).addEventListener("click",u))(),s.addEventListener("click",u),c.addEventListener("click",()=>{o.classList.contains("ncmm-show")?u():l()}),window.addEventListener("hashchange",u),new MutationObserver(g=>{for(let b of g)b.attributeName==="style"&&(o.style.left=a.style.left)}).observe(a,{attributes:!0})}var O=o=>{},Q=()=>{let[o,a]=React.useState(E.PluginMarket),s=React.useRef(null),[c,l]=React.useState([]),[u,g]=React.useState(localStorage.getItem($)!=="true"),[b,y]=React.useState(!1);return React.useEffect(()=>{k().then(y)},[]),React.useEffect(()=>{function t(i,m){let d=n=>{let e=E[n],w=e.haveConfigElement()?1:0;return e.manifest.name.startsWith("PluginMarket")?Number.MAX_SAFE_INTEGER:w};return d(m)-d(i)}l(Object.keys(E).sort(t)),O=i=>{console.log("\u63D2\u4EF6\u52A0\u8F7D\u5B8C\u6210\uFF01"),l(Object.keys(i).sort(t))}},[]),React.useEffect(()=>{let t=o?.injects.map(i=>i._getConfigElement()).filter(i=>i!==null)||[];if(t.length===0){let i=document.createElement("div");i.innerText="\u8BE5\u63D2\u4EF6\u6CA1\u6709\u53EF\u7528\u7684\u8BBE\u7F6E\u9009\u9879",t.push(i)}s.current?.replaceChildren(...t)},[o]),h("div",{className:"bncm-mgr"},h("div",null,h(W,{onRequestOpenStartupWarnings:()=>{g(!u)}}),b?h(z,null):u?h(G,{onRequestClose:()=>{localStorage.setItem($,"true"),g(!1),document.querySelector(".bncm-btn-twinkling")?.classList.remove("bncm-btn-twinkling")}}):h("section",{style:{display:"flex",flexDirection:"row",flex:"1",marginBottom:"0"}},h("div",{className:"v-scroll loaded-plugins-list",style:{borderRight:"1px solid #8885"}},h("div",null,h("div",null,c.map(t=>{let i=E[t],m=i.haveConfigElement();return h("div",{className:m?o?.manifest.slug===t?"plugin-btn selected":"plugin-btn":"plugin-btn-disabled plugin-btn","data-plugin-slug":t,onClick:()=>{m&&a(i)}},h("span",{className:"plugin-list-name"},i.manifest.name),!i.pluginPath.includes("./plugins_dev")&&i.manifest.name!=="PluginMarket"&&h("span",{className:"plugin-uninstall-btn",onClick:async d=>{d.stopPropagation();let n=i.manifest.require_restart||i.manifest.native_plugin,e=await p.fs.readFileText(`${i.pluginPath}/.plugin.path.meta`);e.length>1&&(await p.fs.remove(e),n&&await p.app.reloadPlugins(),p.reload())}},h("svg",{xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",className:"feather feather-trash-2"},h("polyline",{points:"3 6 5 6 21 6"}),h("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),h("line",{x1:10,y1:11,x2:10,y2:17}),h("line",{x1:14,y1:11,x2:14,y2:17}))))})))),h("div",{className:"v-scroll"},h("div",null,h("div",{style:{overflowY:"scroll",overflowX:"hidden",padding:"16px"},ref:s}))))))};var B=class extends EventTarget{pluginPath="";injects=[];manifest;finished=!1;#e=null;devMode=!1;constructor(a,s,c){super(),this.devMode=c,this.manifest=a,this.pluginPath=s,this.addEventListener("load",l=>{this.injects.forEach(u=>{u.dispatchEvent(l)})}),this.addEventListener("allpluginsloaded",l=>{this.injects.forEach(u=>{u.dispatchEvent(l)})})}haveConfigElement(){return this.#e==null&&(this.#e=this.injects.reduce((a,s)=>a??s._getConfigElement(),null)!==null),this.#e}},J;(c=>{function o(l,u,g=!1,b={}){return dom("a",{class:["u-ibtn5",g&&"u-ibtnsz8"],style:{margin:".2em .5em"},innerText:l,onclick:u,...b})}c.makeBtn=o;function a(l={}){return dom("input",{type:"checkbox",...l})}c.makeCheckbox=a;function s(l,u={}){return dom("input",{value:l,style:{margin:".2em .5em",borderRadius:".5em"},class:["u-txt","sc-flag"],...u})}c.makeInput=s})(J||={});var F=class extends EventTarget{constructor(s,c){super();this.filePath=c;this.mainPlugin=s,this.manifest=s.manifest,this.pluginPath=s.pluginPath}pluginPath="";manifest;configViewElement=null;mainPlugin;loadError=null;finished=!1;onLoad(s){this.addEventListener("load",c=>{try{s.call(this,c.detail,c)}catch(l){this.loadError=l}})}onConfig(s){this.addEventListener("config",c=>{this.configViewElement=s.call(this,c.detail)})}onAllPluginsLoaded(s){this.addEventListener("allpluginsloaded",function(c){s.call(this,c.detail,c)})}getConfig(s,c){try{let l=JSON.parse(localStorage.getItem(`config.betterncm.${this.manifest.slug}`)||"{}");if(l[s]!==void 0)return l[s]}catch{}return c}setConfig(s,c){let l=JSON.parse(localStorage.getItem(`config.betterncm.${this.manifest.slug}`)||"{}");(!l||typeof l!="object")&&(l=Object.create(null)),l[s]=c,localStorage[`config.betterncm.${this.manifest.slug}`]=JSON.stringify(l)}_getConfigElement(){return this.configViewElement||this.dispatchEvent(new CustomEvent("config",{detail:J})),this.configViewElement}};var E={},R="betterncm.safemode",L="betterncm.loaderror",D="cc.microblock.betterncm.cpp_side_inject_feature_disabled",v;(l=>{function o(){let u=document.getElementById("bncm-splash-screen");u&&u.animate([{opacity:1},{opacity:0,display:"none"}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42,0,0.58,1)"}).commitStyles()}l.hideSplashScreen=o;function a(){return new Promise(u=>{let g=document.getElementById("bncm-splash-screen");if(!g)return u();let b=g.animate([{opacity:0},{opacity:1}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42, 0, 0.58, 1)"});b.addEventListener("finish",y=>{u()},{once:!0}),b.commitStyles()})}l.showSplashScreen=a;function s(u){let g=document.getElementById("bncm-splash-screen-text");g&&(g.innerText=u)}l.setSplashScreenText=s;function c(u){let g=document.getElementById("bncm-splash-screen-progress");g&&(u===0?g.style.display="none":g.style.display="",g.style.width=`${Math.max(0,Math.min(100,u*100))}%`)}l.setSplashScreenProgress=c})(v||={});async function N(){await p.app.writeConfig(D,"false"),await p.app.writeConfig(R,"false"),await p.app.writeConfig(L,"")}async function ee(){await p.app.writeConfig(D,"true"),await p.app.writeConfig(R,"true")}var A=class extends Error{constructor(s,c,l,u){super(l,u);this.pluginPath=s;this.rawError=c}toString(){return`\u63D2\u4EF6 ${this.pluginPath} \u52A0\u8F7D\u51FA\u9519: ${this.rawError}`}},H=class extends Error{constructor(a,s){super(a,s)}toString(){return`\u63D2\u4EF6\u4F9D\u8D56\u89E3\u6790\u51FA\u9519: ${this}`}},k=()=>p.app.readConfig(R,"false").then(o=>o==="true"),U=()=>p.app.readConfig(L,"").then(o=>o||"");function te(o){class a{adjacencyList={};constructor(){}addVertex(t){this.adjacencyList[t]||(this.adjacencyList[t]=[])}addEdge(t,i){this.adjacencyList[t].push(i)}}let s=new a;for(let y of o)s.addVertex(y.manifest.slug);for(let y of o)y.manifest.loadBefore&&y.manifest.loadBefore.forEach(t=>s.addEdge(t,y.manifest.slug)),y.manifest.loadAfter&&y.manifest.loadAfter.forEach(t=>s.addEdge(y.manifest.slug,t));function c(y,t,i,m){if(i[y]=!0,!(y in s.adjacencyList))throw new H(`\u627E\u4E0D\u5230\u63D2\u4EF6 ${y}`);let d=s.adjacencyList[y];for(let n of d)i[n]||(t=c(n,t,i,m));return m[y]=t,t-1}let l=Object.keys(s.adjacencyList),u={},g={},b=l.length-1;for(let y of l)u[y]||(b=c(y,b,u,g));return Object.keys(g).map(y=>o.find(t=>t.manifest.slug===y))}async function ne(){if(await k()){window.loadedPlugins=E;return}let o=p.utils.debounce(p.reload,1e3),s={"/pub/app.html":"Main"}[location.pathname];async function c(t){let i=t.devMode,m=t.manifest,d=t.pluginPath;i&&!m.noDevReload&&betterncm_native.fs.watchDirectory(d,(e,w)=>{[".js","manifest.json"].findIndex(x=>w.endsWith(x))!==-1&&(console.warn("\u5F00\u53D1\u63D2\u4EF6",m.name,"\u6587\u4EF6",w,"\u53D1\u751F\u66F4\u65B0\uFF0C\u5373\u5C06\u91CD\u8F7D\uFF01"),o())});async function n(e){if(!m.slug)return;let w=await p.fs.readFileText(e);if(e.endsWith(".js")){let r=new F(t,e),x=new Function("plugin",`return (async function ${e.replaceAll(/[/\\\.]/g,"_").replaceAll("-","_").replaceAll(/[^a-zA-Z0-9_$]/g,"")}(){${w}})();`);if(Object.defineProperty(x,"name",{value:e,configurable:!0}),await x.call(E[m.slug],r),r.dispatchEvent(new CustomEvent("load",{detail:r})),r.loadError)throw new A(e,r.loadError,`\u63D2\u4EF6\u811A\u672C ${e} \u52A0\u8F7D\u51FA\u9519: ${r.loadError.stack||r.loadError}`,{cause:r.loadError});r.finished=!0,E[m.slug].injects.push(r)}}if(m.injects[s])for(let e of m.injects[s])await n(`${d}/${e.file}`);if(m.injects[location.pathname])for(let e of m.injects[location.pathname])await n(`${d}/${e.file}`);t.finished=!0}window.loadedPlugins=E,v.setSplashScreenText("\u6B63\u5728\u68C0\u7D22\u63D2\u4EF6"),v.setSplashScreenProgress(0);let l=await p.fs.readDir("./plugins_runtime"),u=[],g=async(t,i)=>{try{let m=JSON.parse(await p.fs.readFileText(`${t}/manifest.json`));m.slug=m.slug??m.name.replace(/[^a-zA-Z0-9 ]/g,"").replace(/ /g,"-");let d=new B(m,t,i);u.push(d)}catch(m){if(m instanceof SyntaxError)console.error("Failed to load plugin:",m);else throw m}};v.setSplashScreenText("\u6B63\u5728\u786E\u8BA4\u63D2\u4EF6\u52A0\u8F7D\u987A\u5E8F"),v.setSplashScreenProgress(0),u=te(u);let b=[];for(let t of l)b.push(g(t,!1));if(v.setSplashScreenText("\u6B63\u5728\u68C0\u7D22\u5F00\u53D1\u63D2\u4EF6"),v.setSplashScreenProgress(0),betterncm_native.fs.exists("./plugins_dev")){let t=await p.fs.readDir("./plugins_dev");for(let i of t)v.setSplashScreenText(`\u6B63\u5728\u52A0\u8F7D\u5F00\u53D1\u63D2\u4EF6 ${i}`),await g(i,!0)}await Promise.all(b);let y=0;for(let t of u)if(t.manifest.slug in E)console.warn("\u63D2\u4EF6",t.manifest.slug,"\u51FA\u73B0\u91CD\u590D\uFF0C\u4F4D\u4E8E",t.pluginPath,"\u7684\u63D2\u4EF6\u5C06\u4E0D\u4F1A\u88AB\u52A0\u8F7D");else{E[t.manifest.slug]=t,console.log("\u6B63\u5728\u52A0\u8F7D\u63D2\u4EF6",t.manifest.slug),v.setSplashScreenText(`\u6B63\u5728\u52A0\u8F7D\u63D2\u4EF6 ${t.manifest.name} (${y++}/${u.length})`),v.setSplashScreenProgress(y/u.length);let i=Date.now();await c(t);let m=Date.now()-i;console.log("\u63D2\u4EF6\u52A0\u8F7D\u5B8C\u6210",t.manifest.slug,"\u7528\u65F6",`${m}ms`)}v.setSplashScreenProgress(1),v.setSplashScreenText("\u6B63\u5728\u5B8C\u6210\u52A0\u8F7D");for(let t in E)E[t].injects.forEach(m=>{if(m.dispatchEvent(new CustomEvent("allpluginsloaded",{detail:E})),m.loadError)throw new A(m.filePath,m.loadError,`\u63D2\u4EF6\u811A\u672C ${m.filePath} \u52A0\u8F7D\u51FA\u9519: ${m.loadError.stack||m.loadError}`,{cause:m.loadError})})}async function ie(o){let a="cc.microblock.loader.reloadPluginAttempts",s=parseInt(await p.app.readConfig(a,"0")),c=await p.app.readConfig(L,"");await p.app.writeConfig(L,`${c}\u7B2C ${s+1} \u6B21\u52A0\u8F7D\u53D1\u751F\u9519\u8BEF\uFF1A
${o.stack||o}

`),s<2?await p.app.writeConfig(a,String(s+1)):(await ee(),await p.app.writeConfig(a,"0")),location.reload()}window.addEventListener("DOMContentLoaded",async()=>{let o=betterncm_native.internal.getFrameworkCSS(),a=document.createElement("style");a.innerHTML=o,document.head.appendChild(a),await p.app.readConfig(D,"false")==="false"?localStorage.setItem(R,"false"):localStorage.setItem(R,"true");try{await Promise.race([Promise.all([ne(),Y()])])}catch(s){ie(s);return}v.setSplashScreenText("\u52A0\u8F7D\u5B8C\u6210\uFF01"),v.hideSplashScreen(),O(E)});function re(){v.setSplashScreenProgress(0),v.setSplashScreenText("\u6B63\u5728\u91CD\u8F7D"),v.showSplashScreen().then(()=>{betterncm_native.app.restart()})}var X={fs:T,app:j,ncm:I,utils:M,tests:V,reload:re,betterncmFetch:P};window.dom=M.dom;betterncm=X;var p=X;})();
//# sourceMappingURL=framework.js.map
